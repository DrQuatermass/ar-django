<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Qualit√† Marker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .marker-upload {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        select {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            width: 100%;
            font-size: 16px;
        }
        input[type="file"] {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: #3a3a3a;
            border: none;
            border-radius: 5px;
            color: white;
            width: 100%;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #results {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .good { color: #4CAF50; }
        .warning { color: #ff9800; }
        .bad { color: #f44336; }
        canvas {
            max-width: 100%;
            border: 2px solid #444;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #3a3a3a;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #555;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        .tab-button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Qualit√† Marker</h1>
        <p>Testa i marker dal database o carica nuove immagini</p>

        <div id="loading-status" style="background: #3a3a3a; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
            ‚è≥ Caricamento OpenCV.js in corso...
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('database')">üìä Test dal Database</button>
            <button class="tab-button" onclick="switchTab('upload')">üì§ Carica File</button>
        </div>

        <!-- Tab Database -->
        <div id="database-tab" class="tab-content active">
            <div class="marker-upload">
                <h3>Seleziona Character dal Database</h3>
                <select id="characterSelect" onchange="loadCharacterMarkers()">
                    <option value="">-- Seleziona un character --</option>
                </select>
                <div id="characterInfo" style="margin-top: 15px; display: none;">
                    <p><strong>Character:</strong> <span id="charName"></span></p>
                    <p><strong>Marker Config:</strong> <span id="charConfig"></span></p>
                    <button onclick="testCharacterMarkers()" id="testCharacterBtn" disabled>Testa Entrambi i Marker</button>
                </div>
            </div>
        </div>

        <!-- Tab Upload -->
        <div id="upload-tab" class="tab-content">
            <div class="marker-upload">
                <h3>Detection Marker (100+ matches richiesti)</h3>
                <input type="file" id="detectionMarker" accept="image/*">
                <button onclick="testMarker('detection')" id="testDetectionBtn" disabled>Testa Detection Marker</button>
            </div>

            <div class="marker-upload">
                <h3>Positioning Marker (40+ matches richiesti)</h3>
                <input type="file" id="positioningMarker" accept="image/*">
                <button onclick="testMarker('positioning')" id="testPositioningBtn" disabled>Testa Positioning Marker</button>
            </div>
        </div>

        <div id="results"></div>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <script>
        let cvReady = false;
        let characters = [];
        let currentCharacter = null;

        // Timeout per caricamento OpenCV (30 secondi)
        setTimeout(function() {
            if (!cvReady) {
                const loadingStatus = document.getElementById('loading-status');
                loadingStatus.innerHTML = '‚ùå Timeout caricamento OpenCV.js. <a href="#" onclick="location.reload()" style="color: #4CAF50;">Ricarica la pagina</a>';
                loadingStatus.style.background = '#f44336';
            }
        }, 30000);
    </script>

    <script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="console.log('OpenCV script loaded')" onerror="handleOpenCVError()"></script>
    <script>
        function handleOpenCVError() {
            const loadingStatus = document.getElementById('loading-status');
            loadingStatus.innerHTML = '‚ùå Errore caricamento OpenCV.js. Verifica la connessione internet. <a href="#" onclick="location.reload()" style="color: #4CAF50;">Ricarica</a>';
            loadingStatus.style.background = '#f44336';
        }

        // Carica characters dal database
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters/');
                const data = await response.json();
                characters = data.characters;

                const select = document.getElementById('characterSelect');
                characters.forEach(char => {
                    const option = document.createElement('option');
                    option.value = char.id;
                    option.textContent = char.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento characters:', error);
            }
        }

        function loadCharacterMarkers() {
            const select = document.getElementById('characterSelect');
            const charId = select.value;

            if (!charId) {
                document.getElementById('characterInfo').style.display = 'none';
                return;
            }

            currentCharacter = characters.find(c => c.id == charId);

            document.getElementById('charName').textContent = currentCharacter.name;

            let config = [];
            if (currentCharacter.marker_image) config.push('Detection Marker ‚úì');
            if (currentCharacter.positioning_marker_image) config.push('Positioning Marker ‚úì');
            if (currentCharacter.use_marker) config.push('Marker Mode ON');

            document.getElementById('charConfig').textContent = config.join(', ') || 'Nessun marker configurato';
            document.getElementById('characterInfo').style.display = 'block';

            const testBtn = document.getElementById('testCharacterBtn');
            if (cvReady && (currentCharacter.marker_image || currentCharacter.positioning_marker_image)) {
                testBtn.disabled = false;
                testBtn.textContent = 'Testa Entrambi i Marker';
            } else if (!cvReady) {
                testBtn.disabled = true;
                testBtn.textContent = 'Attendere caricamento OpenCV...';
            } else {
                testBtn.disabled = true;
                testBtn.textContent = 'Nessun marker disponibile';
            }
        }

        async function testCharacterMarkers() {
            if (!currentCharacter) return;

            document.getElementById('results').innerHTML = '<p>‚è≥ Caricamento e analisi marker...</p>';

            let results = [];

            // Test Detection Marker
            if (currentCharacter.marker_image) {
                const detectionResult = await testMarkerFromUrl(currentCharacter.marker_image, 'detection');
                results.push(detectionResult);
            }

            // Test Positioning Marker
            if (currentCharacter.positioning_marker_image) {
                const positioningResult = await testMarkerFromUrl(currentCharacter.positioning_marker_image, 'positioning');
                results.push(positioningResult);
            }

            // Mostra risultati combinati
            document.getElementById('results').innerHTML = results.join('<hr style="border-color: #555; margin: 20px 0;">');
        }

        function testMarkerFromUrl(url, type) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const result = analyzeMarker(img, type);
                    resolve(result);
                };
                img.onerror = function() {
                    resolve(`<div class="status bad"><h3>‚ùå Errore caricamento ${type} marker</h3><p>Impossibile caricare l'immagine da: ${url}</p></div>`);
                };
                img.src = url;
            });
        }

        function switchTab(tab) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            // Clear results
            document.getElementById('results').innerHTML = '';
            document.getElementById('canvas').style.display = 'none';
        }

        // Polling per verificare quando cv √® disponibile
        let checkCount = 0;
        const checkInterval = setInterval(function() {
            checkCount++;
            const loadingStatus = document.getElementById('loading-status');

            if (typeof cv !== 'undefined' && cv.Mat) {
                clearInterval(checkInterval);
                onOpenCvReady();
            } else if (checkCount > 60) {
                // Dopo 30 secondi (60 * 500ms) di polling
                clearInterval(checkInterval);
                loadingStatus.innerHTML = '‚ùå OpenCV.js non risponde. <a href="#" onclick="location.reload()" style="color: #4CAF50;">Ricarica</a>';
                loadingStatus.style.background = '#f44336';
            } else {
                // Mostra punti animati
                const dots = '.'.repeat((checkCount % 4));
                loadingStatus.innerHTML = `‚è≥ Caricamento OpenCV.js in corso${dots}`;
            }
        }, 500);

        // Attendi caricamento OpenCV
        function onOpenCvReady() {
            cvReady = true;
            console.log('‚úÖ OpenCV caricato');

            // Aggiorna status
            const loadingStatus = document.getElementById('loading-status');
            loadingStatus.innerHTML = '‚úÖ OpenCV.js caricato - Pronto per testare i marker!';
            loadingStatus.style.background = '#4CAF50';

            // Abilita pulsanti upload
            document.getElementById('testDetectionBtn').disabled = false;
            document.getElementById('testPositioningBtn').disabled = false;

            // Abilita pulsante test character se gi√† selezionato
            if (currentCharacter && (currentCharacter.marker_image || currentCharacter.positioning_marker_image)) {
                document.getElementById('testCharacterBtn').disabled = false;
                document.getElementById('testCharacterBtn').textContent = 'Testa Entrambi i Marker';
            }
        }

        // Abilita pulsanti quando file selezionati
        document.getElementById('detectionMarker').addEventListener('change', function(e) {
            if (e.target.files.length > 0 && cvReady) {
                document.getElementById('testDetectionBtn').disabled = false;
            }
        });

        document.getElementById('positioningMarker').addEventListener('change', function(e) {
            if (e.target.files.length > 0 && cvReady) {
                document.getElementById('testPositioningBtn').disabled = false;
            }
        });

        function testMarker(type) {
            const fileInput = type === 'detection' ?
                document.getElementById('detectionMarker') :
                document.getElementById('positioningMarker');

            const file = fileInput.files[0];
            if (!file) {
                alert('Seleziona un file prima!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const result = analyzeMarker(img, type);
                    document.getElementById('results').innerHTML = result;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function analyzeMarker(img, type) {
            const canvas = document.getElementById('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            // Converti in Mat OpenCV
            const src = cv.imread(canvas);
            const gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // Configura ORB detector
            const nfeatures = type === 'detection' ? 1000 : 500;
            const orb = new cv.ORB(nfeatures);

            // Rileva keypoints
            const keypoints = new cv.KeyPointVector();
            const descriptors = new cv.Mat();
            orb.detect(gray, keypoints);
            orb.compute(gray, keypoints, descriptors);

            const numKeypoints = keypoints.size();
            const threshold = type === 'detection' ? 100 : 40;

            // Disegna keypoints
            const output = new cv.Mat();
            cv.drawKeypoints(src, keypoints, output, new cv.Scalar(0, 255, 0, 255));
            cv.imshow('canvas', output);
            canvas.style.display = 'block';

            // Analizza risultati
            let status = '';
            let className = '';

            if (numKeypoints >= threshold * 2) {
                status = '‚úÖ OTTIMO';
                className = 'good';
            } else if (numKeypoints >= threshold) {
                status = '‚ö†Ô∏è SUFFICIENTE';
                className = 'warning';
            } else {
                status = '‚ùå INSUFFICIENTE';
                className = 'bad';
            }

            // Cleanup
            src.delete();
            gray.delete();
            keypoints.delete();
            descriptors.delete();
            output.delete();

            // Return HTML
            return `
                <div class="status ${className}">
                    <h3>${status} - ${type === 'detection' ? 'Detection Marker' : 'Positioning Marker'}</h3>
                    <p><strong>Keypoints rilevati:</strong> ${numKeypoints}</p>
                    <p><strong>Soglia minima:</strong> ${threshold}</p>
                    <p><strong>Descrittori:</strong> ${descriptors.rows} x ${descriptors.cols}</p>

                    ${numKeypoints < threshold ? `
                        <h4>‚ö†Ô∏è Consigli per migliorare:</h4>
                        <ul>
                            <li>Aumenta il contrasto dell'immagine</li>
                            <li>Aggiungi pi√π dettagli geometrici (angoli, linee)</li>
                            <li>Usa pattern pi√π complessi</li>
                            <li>Evita aree uniformi</li>
                            <li>Rendi il marker pi√π asimmetrico</li>
                        </ul>
                    ` : ''}

                    <p style="margin-top: 15px;"><em>I punti verdi nell'immagine mostrano i keypoint rilevati da OpenCV</em></p>
                </div>
            `;
        }

        // Carica characters all'avvio
        loadCharacters();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Camera</title>
    {% load static %}
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #camera-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ar-character {
            position: absolute;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ar-character img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }

        .ar-character.active {
            width: 150px;
            height: 150px;
        }

        .ar-character.active img {
            width: 120px;
            height: 120px;
        }

        .ar-character-info {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            margin-top: 5px;
            max-width: 120px;
        }


        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 200px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 10px;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 3px;
            margin: 1px 0;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-title {
            font-size: 9px;
            font-weight: bold;
            margin-right: 4px;
        }

        .info-value {
            font-size: 9px;
            color: #00ff00;
        }

        #character-pointer {
            position: fixed;
            bottom: 80px;
            left: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, 0);
            z-index: 15;
            display: none;
        }

        #pointer-arrow {
            width: 4px;
            height: 50px;
            background: #00ff00;
            margin: 0 auto;
            transform-origin: 50% 100%;
            transition: transform 0.1s ease-out;
            position: relative;
            border-radius: 2px 2px 0 0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        #pointer-arrow::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #00ff00;
        }

        #pointer-info {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            margin-top: 5px;
        }

        #error-message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 30;
            display: none;
        }

        @media (max-width: 768px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }

            .info-panel {
                margin: 2px 0;
            }
        }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="camera-stream" autoplay playsinline></video>
        <div id="ar-overlay"></div>
    </div>

    <div id="controls">
        <div class="info-panel">
            <div class="info-title">GPS</div>
            <div class="info-value" id="gps-coords">Caricamento...</div>
        </div>

        <div class="info-panel">
            <div class="info-title">Accuracy</div>
            <div class="info-value" id="gps-accuracy">-</div>
        </div>

        <div class="info-panel">
            <div class="info-title">Nearest</div>
            <div class="info-value" id="nearest-distance">-</div>
        </div>

        <div class="info-panel">
            <div class="info-title">Compass</div>
            <div class="info-value" id="compass-status">OFF</div>
        </div>

        <div class="info-panel">
            <div class="info-title">Characters</div>
            <div class="info-value" id="character-count">{{ characters.count }}</div>
        </div>
    </div>

    <div id="character-pointer">
        <div id="pointer-arrow"></div>
        <div id="pointer-info">
            <div id="pointer-name">-</div>
            <div id="pointer-distance">-</div>
        </div>
    </div>

    <div id="compass-button" style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 5px; border: none; font-size: 12px; z-index: 25; cursor: pointer;">
        Enable Compass
    </div>

    <div id="error-message"></div>

    <script>
        class ARCamera {
            constructor() {
                this.currentPosition = null;
                this.currentHeading = 0;
                this.characters = [];
                this.activeCharacters = [];
                this.nearestCharacter = null;
                this.lastUpdate = 0;

                this.initCamera();
                this.initGPS();
                this.loadCharacterData();
                this.setupCompassButton();
            }

            async initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    document.getElementById('camera-stream').srcObject = stream;
                } catch (error) {
                    this.showError('Errore accesso fotocamera: ' + error.message);
                }
            }

            initGPS() {
                if (!navigator.geolocation) {
                    this.showError('GPS non supportato su questo dispositivo');
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };

                navigator.geolocation.watchPosition(
                    (position) => {
                        this.currentPosition = position;
                        this.updateGPSDisplay();
                        this.updateAROverlay();
                        this.updateCharacterPointer();
                    },
                    (error) => {
                        this.showError('Errore GPS: ' + error.message);
                    },
                    options
                );
            }

            setupCompassButton() {
                const button = document.getElementById('compass-button');
                button.addEventListener('click', async () => {
                    button.textContent = 'Activating...';
                    await this.initOrientation();
                });
            }

            async initOrientation() {
                try {
                    const status = document.getElementById('compass-status');

                    // Richiedi permessi per orientamento dispositivo (iOS 13+)
                    if (typeof DeviceOrientationEvent !== 'undefined' &&
                        typeof DeviceOrientationEvent.requestPermission === 'function') {

                        const permission = await DeviceOrientationEvent.requestPermission();

                        if (permission === 'granted') {
                            this.startOrientationListening();
                            status.textContent = 'ON';
                            document.getElementById('compass-button').style.display = 'none';
                        } else {
                            status.textContent = 'DENIED';
                        }
                    } else {
                        // Per Android e browser più vecchi
                        this.startOrientationListening();
                        status.textContent = 'ON';
                        document.getElementById('compass-button').style.display = 'none';
                    }
                } catch (error) {
                    console.log('Errore richiesta permessi orientamento:', error);
                    document.getElementById('compass-status').textContent = 'ERROR';
                }
            }

            startOrientationListening() {
                if (window.DeviceOrientationEvent) {
                    // Usa deviceorientationabsolute per il nord magnetico assoluto (iOS/Android moderni)
                    window.addEventListener('deviceorientationabsolute', (event) => {
                        if (event.alpha !== null) {
                            // Per iOS, event.alpha è relativo al nord magnetico
                            // Per Android con supporto assoluto, è già corretto
                            this.currentHeading = event.alpha;
                            document.getElementById('compass-status').textContent = `${Math.round(event.alpha)}°`;
                            this.throttledUpdatePointer();
                        }
                    });

                    // Fallback per dispositivi senza supporto assoluto
                    window.addEventListener('deviceorientation', (event) => {
                        if (event.alpha !== null) {
                            // Su alcuni dispositivi potrebbe essere necessario correggere l'orientamento
                            let heading = event.alpha;

                            // Correzione per iOS dove l'orientamento potrebbe essere diverso
                            if (event.webkitCompassHeading) {
                                heading = event.webkitCompassHeading;
                            }

                            this.currentHeading = heading;
                            document.getElementById('compass-status').textContent = `${Math.round(heading)}°`;
                            this.throttledUpdatePointer();
                        }
                    });
                } else {
                    document.getElementById('compass-status').textContent = 'NOT_SUPPORTED';
                }
            }

            throttledUpdatePointer() {
                const now = Date.now();
                if (now - this.lastUpdate > 50) { // Aggiorna max ogni 50ms
                    this.lastUpdate = now;
                    this.updateCharacterPointer();
                }
            }

            findNearestCharacter() {
                if (!this.currentPosition || this.characters.length === 0) return null;

                let nearest = null;
                let minDistance = Infinity;

                this.characters.forEach(character => {
                    const distance = this.calculateDistance(
                        this.currentPosition.coords.latitude,
                        this.currentPosition.coords.longitude,
                        character.target_latitude,
                        character.target_longitude
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...character, distance: distance };
                    }
                });

                return nearest;
            }

            async loadCharacterData() {
                try {
                    const response = await fetch('/api/characters/');
                    const data = await response.json();
                    this.characters = data.characters;
                } catch (error) {
                    this.showError('Errore caricamento personaggi: ' + error.message);
                }
            }

            updateGPSDisplay() {
                if (this.currentPosition) {
                    const lat = this.currentPosition.coords.latitude.toFixed(6);
                    const lng = this.currentPosition.coords.longitude.toFixed(6);
                    const accuracy = Math.round(this.currentPosition.coords.accuracy);

                    document.getElementById('gps-coords').textContent = `${lat}, ${lng}`;
                    document.getElementById('gps-accuracy').textContent = `±${accuracy}m`;
                }
            }

            updateCharacterPointer() {
                const nearest = this.findNearestCharacter();
                const pointer = document.getElementById('character-pointer');
                const arrow = document.getElementById('pointer-arrow');
                const nameEl = document.getElementById('pointer-name');
                const distanceEl = document.getElementById('pointer-distance');
                const nearestDistanceEl = document.getElementById('nearest-distance');

                if (nearest && this.currentPosition) {
                    // Aggiorna info nel pannello superiore
                    nearestDistanceEl.textContent = `${Math.round(nearest.distance)}m`;

                    // Calcola la direzione verso il character più vicino
                    const bearing = this.calculateBearing(
                        this.currentPosition.coords.latitude,
                        this.currentPosition.coords.longitude,
                        nearest.target_latitude,
                        nearest.target_longitude
                    );

                    // Calcola la direzione relativa considerando l'orientamento del dispositivo
                    // La freccia punta nella direzione corretta relativa all'orientamento
                    const relativeBearing = (bearing - this.currentHeading + 360) % 360;

                    // Mostra il puntatore e aggiorna la direzione della freccia
                    pointer.style.display = 'block';
                    arrow.style.transform = `rotate(${relativeBearing}deg)`;
                    nameEl.textContent = nearest.name;
                    distanceEl.textContent = `${Math.round(nearest.distance)}m`;

                    // Aggiorna il character più vicino
                    this.nearestCharacter = nearest;
                } else {
                    pointer.style.display = 'none';
                    nearestDistanceEl.textContent = '-';
                    this.nearestCharacter = null;
                }
            }

            updateAROverlay() {
                if (!this.currentPosition || this.characters.length === 0) return;

                const overlay = document.getElementById('ar-overlay');
                overlay.innerHTML = '';

                this.characters.forEach(character => {
                    const distance = this.calculateDistance(
                        this.currentPosition.coords.latitude,
                        this.currentPosition.coords.longitude,
                        character.target_latitude,
                        character.target_longitude
                    );

                    if (distance <= character.activation_distance) {
                        this.createARCharacter(character, distance);
                    }
                });
            }

            createARCharacter(character, distance) {
                const overlay = document.getElementById('ar-overlay');
                const characterDiv = document.createElement('div');
                characterDiv.className = 'ar-character';

                if (distance <= 5) {
                    characterDiv.classList.add('active');
                }

                const bearing = this.calculateBearing(
                    this.currentPosition.coords.latitude,
                    this.currentPosition.coords.longitude,
                    character.target_latitude,
                    character.target_longitude
                );

                const screenPosition = this.worldToScreen(bearing, distance);

                characterDiv.style.left = screenPosition.x + 'px';
                characterDiv.style.top = screenPosition.y + 'px';

                // Mostra solo l'immagine del personaggio
                if (character.character_image) {
                    characterDiv.innerHTML = `
                        <img src="${character.character_image}" alt="${character.name}">
                        <div class="ar-character-info">
                            <div><strong>${character.name}</strong></div>
                            <div>${Math.round(distance)}m</div>
                        </div>
                    `;
                    overlay.appendChild(characterDiv);
                }
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Raggio Terra in metri
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            calculateBearing(lat1, lon1, lat2, lon2) {
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const y = Math.sin(Δλ) * Math.cos(φ2);
                const x = Math.cos(φ1) * Math.sin(φ2) -
                        Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

                const θ = Math.atan2(y, x);

                return (θ*180/Math.PI + 360) % 360;
            }

            worldToScreen(bearing, distance) {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                // Converti bearing relativo alla direzione della fotocamera
                const relativeBearing = (bearing - this.currentHeading + 360) % 360;

                // Mappa il bearing su coordinate schermo (FOV di 90 gradi)
                const x = screenWidth * (relativeBearing / 90) % screenWidth;

                // La distanza influenza la posizione verticale
                const y = screenHeight * 0.3 + (distance / 100) * screenHeight * 0.4;

                return { x: Math.max(50, Math.min(x, screenWidth - 50)), y: Math.max(100, Math.min(y, screenHeight - 100)) };
            }

            showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Avvia l'applicazione AR quando la pagina è caricata
        document.addEventListener('DOMContentLoaded', () => {
            new ARCamera();
        });

        // Gestisci il cambio di orientamento
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                location.reload();
            }, 500);
        });
    </script>
</body>
</html>